<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timetable Makerüï∞Ô∏è</title>
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f8f8f8;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
    }
    #app {
      width: 80%;
      background-color: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 4px 0;
    }
    button {
      margin-top: 10px;
      padding: 8px;
      cursor: pointer;
      background-color: #4caf50;
      color: #fff;
      border: none;
      border-radius: 4px;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .highlight {
      background-color: #ffc0cb;
    }
    .popup {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 20px;
      background-color: #ff6666;
      color: #fff;
      border-radius: 8px;
      z-index: 1000;
    }
    .popup input {
      width: 100%;
      box-sizing: border-box;
      padding: 8px;
      margin: 4px 0;
    }
    .header {
      background-color: #4caf50;
    padding: 10px;
    text-align: center;
    color: #fff;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-radius: 8px;
    }
    .header-buttons {
    display: flex;
    gap: 10px;
    }
  </style>
</head>
<body>

  <div id="app">
    <div class="header">
      <h1>Timetable Makerüï∞Ô∏è</h1>
      <div class="popup" v-if="showPopup">
        <div v-if="popupType === 'login'">
          <h3>Login</h3>
          <label>Nutzername:</label>
          <input v-model="loginUsername" type="text">
          <label>Passwort:</label>
          <input v-model="loginPassword" type="password">
          <button @click="performLogin">Log In</button>
        </div>
        <div v-if="popupType === 'register'">
          <h3>Registrieren</h3>
          <label>Nutzername:</label>
          <input v-model="registerUsername" type="text">
          <label>Passwort:</label>
          <input v-model="registerPassword" type="password">
          <label>Passwort wiederholen:</label>
          <input v-model="repeatPassword" type="password">
          <button @click="performRegister">Register</button>
        </div>
        <button @click="hidePopup">Abbrechen</button>
      </div>
      <div>
        <button @click="login" v-if="!loggedIn">Log In</button>
        <button @click="register" v-if="!loggedIn">Register</button>
      </div>
    </div>
    <h2>Timetable Maker</h2>
    <input v-model="timetableName" placeholder="Timetable Name">
    <table>
      <thead>
        <tr>
          <th>Time/Day</th>
          <th v-for="(day, index) in days" :key="index">
            <input v-model="days[index]" placeholder="Day">
          </th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(row, rowIndex) in timetable" :key="rowIndex" :class="{ 'highlight': rowIndex === highlightRowIndex }">
          <td>
            <input v-model="row.time" placeholder="Time">
          </td>
          <td v-for="(cell, cellIndex) in row.cells" :key="cellIndex" :class="{ 'highlight': cellIndex === highlightColumnIndex }">
            <input v-model="cell" placeholder="Activity">
          </td>
        </tr>
      </tbody>
    </table>
    <button @click="addRow">Add Row</button>
    <button @click="addColumn">Add Column</button>
    <button @click="saveData">Save</button>
    <button @click="deleteRow">Delete Row</button>
    <button @click="deleteColumn">Delete Column</button>
    <button @click="saveAsPNG">Save as PNG</button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
  <script>
    const authServerUrl = "http://localhost:2941/auth";
    const ressourceServerUrl = "http://localhost:2940/api/v2/entities";

    new Vue({
      el: '#app',
      data: {
        loggedIn: false,
        days: ['', '', '', '', ''],
        timetable: Array.from({ length: 5 }, () => ({
          time: '',
          cells: Array(5).fill('')
        })),
        timetableName: '',
        deletingColumn: null,
        showPopup: false,
        popupType: 'login',
        loginUsername: '',
        loginPassword: '',
        registerUsername: '',
        registerPassword: '',
        repeatPassword: '',
        highlightColumnIndex: null,
        highlightRowIndex: null
      },
      methods: {
        deleteRow() {
          if (this.timetable.length > 1) {
            this.timetable.pop();
          }
        },

        deleteColumn() {
          if (this.days.length > 1) {
            this.days.pop();
            this.timetable.forEach(row => row.cells.pop());
          }
        },
        addRow() {
          this.timetable.push({ time: '', cells: Array(this.days.length).fill('') });
        },
        addColumn() {
          this.days.push('New Day');
          this.timetable.forEach(row => row.cells.push(''));
        },
        startDeletingColumns() {
          this.deletingColumn = this.days.length - 1;
        },
        stopDeletingColumns() {
          this.deletingColumn = null;
        },
        saveData() {
          if (!this.loggedIn) {
            this.showPopup = true;
            return;
          }

          const data = {
            username: null,
            scheduleId: null,
            timetableName: this.timetableName,
            days: this.days.slice(1),
            times: this.timetable.map(row => row.time),
            data: this.timetable.map(row => row.cells)
          };
          // Implement the logic to save data (e.g., API request to the server).
          console.log('Save data:', data);
        },
        login() {
          this.showLoginPopup();
        },
        register() {
          this.showRegisterPopup();
        },
        hidePopup() {
          this.showPopup = false;
        },
        showLoginPopup() {
          this.popupType = 'login';
          this.showPopup = true;
        },
        showRegisterPopup() {
          this.popupType = 'register';
          this.showPopup = true;
        },
        performLogin() {
          const username = this.loginUsername;
          const password = this.loginPassword;
          this.login(username, password);
        },
        performRegister() {
          const username = this.registerUsername;
          const password = this.registerPassword;
          const repeatPassword = this.repeatPassword;
          this.register(username, password, repeatPassword);
        },
        login(username, password) {
          fetch(`${authServerUrl}/login`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
            }),
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error("Login failed");
              }
            })
            .then((data) => {
              localStorage.setItem("accesstoken", data.accessToken);
              localStorage.setItem("refreshtoken", data.refreshToken);
              this.loggedIn = true;
              this.showPopup = false;
            })
            .catch(() => {
              console.error("Login error");
            });
        },
        register(username, password, repeatPassword) {
          if (password !== repeatPassword) {
            console.error("Passwords do not match");
            return;
          }

          fetch(`${authServerUrl}/register`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              username: username,
              password: password,
            }),
          })
            .then((response) => {
              if (response.ok) {
                return response.json();
              } else {
                throw new Error("Registration failed");
              }
            })
            .then((data) => {
              localStorage.setItem("accesstoken", data.accessToken);
              localStorage.setItem("refreshtoken", data.refreshToken);
              this.loggedIn = true;
              this.showPopup = false;
            })
            .catch(() => {
              console.error("Registration error");
            });
        },
        saveAsPNG() {
          const canvas = document.createElement('canvas');
          const ctx = canvas.getContext('2d');
          const table = document.querySelector('table');

          canvas.width = table.offsetWidth;
          canvas.height = table.offsetHeight;

          const rows = table.querySelectorAll('tr');

          rows.forEach((row, rowIndex) => {
            const cells = row.querySelectorAll('td, th');
            cells.forEach((cell, cellIndex) => {
              ctx.fillStyle = getComputedStyle(cell).backgroundColor;
              ctx.fillRect(cell.offsetLeft, cell.offsetTop, cell.offsetWidth, cell.offsetHeight);

              if (cellIndex === 0) {
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(cell.offsetLeft + cell.offsetWidth, cell.offsetTop);
                ctx.lineTo(cell.offsetLeft + cell.offsetWidth, cell.offsetTop + cell.offsetHeight);
                ctx.stroke();
              }

              if (rowIndex === 0) {
                ctx.strokeStyle = '#ddd';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(cell.offsetLeft, cell.offsetTop + cell.offsetHeight);
                ctx.lineTo(cell.offsetLeft + cell.offsetWidth, cell.offsetTop + cell.offsetHeight);
                ctx.stroke();
              }
            });
          });

          const dataURL = canvas.toDataURL('image/png');

          const link = document.createElement('a');
          link.href = dataURL;
          link.download = 'timetable.png';
          link.click();
        },
        // ... your existing methods
      },
    });

    function generateId() {
      return Math.random().toString(36).substr(2, 9);
    }
  </script>

</body>
</html>
